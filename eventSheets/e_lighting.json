{
	"name": "e_lighting",
	"events": [
		{
			"eventType": "group",
			"disabled": false,
			"title": "Lighting",
			"description": "",
			"isActiveOnStart": true,
			"children": [
				{
					"eventType": "variable",
					"name": "lightingLayer",
					"type": "string",
					"initialValue": "lights",
					"comment": "",
					"isStatic": false,
					"isConstant": true,
					"sid": 995677619125944
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "on-created",
							"objectClass": "glow",
							"sid": 863824773540380
						}
					],
					"actions": [],
					"sid": 300481830049518,
					"children": [
						{
							"eventType": "block",
							"conditions": [],
							"actions": [
								{
									"id": "spawn-another-object",
									"objectClass": "glow",
									"sid": 770695814013915,
									"parameters": {
										"object": "FogMask",
										"layer": "lightingLayer",
										"image-point": "\"center\"",
										"create-hierarchy": false
									}
								},
								{
									"id": "add-child",
									"objectClass": "glow",
									"sid": 666840338139019,
									"parameters": {
										"child": "FogMask",
										"transform-x": true,
										"transform-y": true,
										"transform-w": false,
										"transform-h": false,
										"transform-a": false,
										"transform-o": false,
										"transform-z-elevation": false,
										"transform-visibility": false,
										"destroy-with-parent": true
									}
								}
							],
							"sid": 308241552524465,
							"children": [
								{
									"eventType": "block",
									"conditions": [
										{
											"id": "pick-children",
											"objectClass": "glow",
											"sid": 660339606294768,
											"parameters": {
												"child": "FogMask",
												"which": "own"
											}
										}
									],
									"actions": [],
									"sid": 358353854040604,
									"children": [
										{
											"eventType": "comment",
											"text": "Use the smaller sprite for the rest of the objects."
										},
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "pick-by-unique-id",
													"objectClass": "actuals",
													"sid": 385925173068080,
													"parameters": {
														"unique-id": "glow.UID"
													}
												}
											],
											"actions": [
												{
													"id": "set-animation",
													"objectClass": "FogMask",
													"sid": 631513265731994,
													"parameters": {
														"animation": "\"64\"",
														"from": "beginning"
													}
												}
											],
											"sid": 214660483776418
										},
										{
											"eventType": "comment",
											"text": "Use a slightly bigger sprite for the player object, so it's definitely visible all the time."
										},
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "else",
													"objectClass": "System",
													"sid": 950048536583492
												}
											],
											"actions": [
												{
													"id": "set-animation",
													"objectClass": "FogMask",
													"sid": 184299580933182,
													"parameters": {
														"animation": "\"128\"",
														"from": "beginning"
													}
												}
											],
											"sid": 168286095006739
										}
									]
								}
							]
						}
					]
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "is-playing",
							"objectClass": "FogMask",
							"sid": 797330173085342,
							"behaviorType": "Tween",
							"parameters": {
								"tags": "\"shrink\""
							}
						}
					],
					"actions": [
						{
							"id": "set-scale",
							"objectClass": "FogMask",
							"sid": 373970230498176,
							"parameters": {
								"scale": "Self.Tween.Value(\"shrink\")"
							}
						}
					],
					"sid": 142642966270613
				},
				{
					"functionName": "initLights",
					"functionDescription": "",
					"functionCategory": "lighting",
					"functionReturnType": "none",
					"functionCopyPicked": false,
					"functionIsAsync": false,
					"functionParameters": [
						{
							"name": "darkness",
							"type": "number",
							"initialValue": "10",
							"comment": "",
							"sid": 828351484032640
						}
					],
					"eventType": "function-block",
					"conditions": [],
					"actions": [],
					"sid": 842008762995693,
					"children": [
						{
							"eventType": "block",
							"conditions": [
								{
									"id": "evaluate-expression",
									"objectClass": "System",
									"sid": 784361768377986,
									"parameters": {
										"value": "LayerIndex(lightingLayer) = -1"
									}
								}
							],
							"actions": [
								{
									"callFunction": "throwIf",
									"sid": 155736396936823,
									"parameters": [
										"\"\"",
										"\"\"",
										"\"Missing lighting layer '\"& lightingLayer & \"'\""
									]
								}
							],
							"sid": 233811989111626
						},
						{
							"eventType": "block",
							"conditions": [],
							"actions": [
								{
									"id": "set-layer-force-own-texture",
									"objectClass": "System",
									"sid": 462233246365543,
									"parameters": {
										"layer": "lightingLayer",
										"mode": "on"
									}
								},
								{
									"id": "set-layer-effect-enabled",
									"objectClass": "System",
									"sid": 869561477812762,
									"parameters": {
										"layer": "lightingLayer",
										"mode": "enable",
										"effect": "\"Multiply\""
									}
								}
							],
							"sid": 636784214192288
						}
					]
				},
				{
					"eventType": "group",
					"disabled": false,
					"title": "Rim Light",
					"description": "",
					"isActiveOnStart": true,
					"children": [
						{
							"eventType": "comment",
							"text": "dynamic rim lights on dolls"
						},
						{
							"eventType": "block",
							"conditions": [
								{
									"id": "for-each",
									"objectClass": "System",
									"sid": 307475680680771,
									"parameters": {
										"object": "dolls"
									}
								}
							],
							"actions": [],
							"sid": 855129072439736,
							"children": [
								{
									"eventType": "block",
									"conditions": [
										{
											"id": "pick-nearestfurthest",
											"objectClass": "lightSource",
											"sid": 378529984696504,
											"parameters": {
												"which": "nearest",
												"x": "dolls.X",
												"y": "dolls.Y"
											}
										}
									],
									"actions": [],
									"sid": 641638283561479,
									"children": [
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "evaluate-expression",
													"objectClass": "System",
													"sid": 591882820835669,
													"parameters": {
														"value": "distance(dolls.X, dolls.Y, lightSource.X, lightSource.Y) < 2 * lightSource.Width"
													}
												}
											],
											"actions": [],
											"sid": 498437755883241,
											"children": [
												{
													"eventType": "block",
													"conditions": [
														{
															"id": "has-los-to-object",
															"objectClass": "lightSource",
															"sid": 783661496144008,
															"behaviorType": "LineOfSight",
															"parameters": {
																"object": "dolls",
																"image-point": "0"
															}
														}
													],
													"actions": [
														{
															"id": "set-effect-enabled",
															"objectClass": "dolls",
															"sid": 723790126462962,
															"parameters": {
																"mode": "enable",
																"effect": "\"RimLight\""
															}
														},
														{
															"callFunction": "fadeInRimLight",
															"sid": 519641251505890
														},
														{
															"callFunction": "drawRrimLight",
															"sid": 747723486794408,
															"disabled": true,
															"parameters": [
																"-1"
															]
														}
													],
													"sid": 283521346362144
												},
												{
													"eventType": "block",
													"conditions": [
														{
															"id": "else",
															"objectClass": "System",
															"sid": 595247706911047
														}
													],
													"actions": [
														{
															"callFunction": "fadeOutRimLight",
															"sid": 263143612442320
														}
													],
													"sid": 593276458240534
												}
											]
										},
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "else",
													"objectClass": "System",
													"sid": 392983262531292
												}
											],
											"actions": [
												{
													"id": "set-effect-enabled",
													"objectClass": "dolls",
													"sid": 135420172461525,
													"parameters": {
														"mode": "disable",
														"effect": "\"RimLight\""
													}
												}
											],
											"sid": 204940822431660
										}
									]
								}
							]
						},
						{
							"functionName": "fadeOutRimLight",
							"functionDescription": "",
							"functionCategory": "",
							"functionReturnType": "none",
							"functionCopyPicked": true,
							"functionIsAsync": false,
							"functionParameters": [],
							"eventType": "function-block",
							"conditions": [],
							"actions": [],
							"sid": 906690819894756,
							"children": [
								{
									"eventType": "variable",
									"name": "intensity",
									"type": "number",
									"initialValue": "0",
									"comment": "",
									"isStatic": false,
									"isConstant": false,
									"sid": 741509910948373
								},
								{
									"eventType": "block",
									"conditions": [
										{
											"id": "is-effect-enabled",
											"objectClass": "dolls",
											"sid": 435896201324982,
											"parameters": {
												"effect": "\"RimLight\""
											}
										}
									],
									"actions": [
										{
											"id": "set-eventvar-value",
											"objectClass": "System",
											"sid": 503645300303417,
											"parameters": {
												"variable": "intensity",
												"value": "Functions.getEffectValue(\"RimLight\", 2, dolls.UID)"
											}
										}
									],
									"sid": 324785639319951,
									"children": [
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "compare-two-values",
													"objectClass": "System",
													"sid": 980912182214721,
													"parameters": {
														"first-value": "intensity",
														"comparison": 4,
														"second-value": "0"
													}
												}
											],
											"actions": [
												{
													"callFunction": "drawRrimLight",
													"sid": 560115601112345,
													"parameters": [
														"lerp(intensity, 0, 0.1 * 120 * dt)"
													]
												}
											],
											"sid": 877924086321924
										},
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "else",
													"objectClass": "System",
													"sid": 859301996993811
												}
											],
											"actions": [
												{
													"id": "set-effect-enabled",
													"objectClass": "dolls",
													"sid": 893773832645452,
													"parameters": {
														"mode": "disable",
														"effect": "\"RimLight\""
													}
												}
											],
											"sid": 142836834548214
										}
									]
								}
							]
						},
						{
							"functionName": "fadeInRimLight",
							"functionDescription": "",
							"functionCategory": "",
							"functionReturnType": "none",
							"functionCopyPicked": true,
							"functionIsAsync": false,
							"functionParameters": [],
							"eventType": "function-block",
							"conditions": [],
							"actions": [],
							"sid": 405602998465186,
							"children": [
								{
									"eventType": "variable",
									"name": "intensity",
									"type": "number",
									"initialValue": "-1",
									"comment": "",
									"isStatic": false,
									"isConstant": false,
									"sid": 817460346054495
								},
								{
									"eventType": "variable",
									"name": "curIntensity",
									"type": "number",
									"initialValue": "0",
									"comment": "",
									"isStatic": false,
									"isConstant": false,
									"sid": 352065970472392
								},
								{
									"eventType": "variable",
									"name": "potentialIntensity",
									"type": "number",
									"initialValue": "0",
									"comment": "",
									"isStatic": false,
									"isConstant": false,
									"sid": 731540843316779
								},
								{
									"eventType": "block",
									"conditions": [],
									"actions": [
										{
											"id": "set-eventvar-value",
											"objectClass": "System",
											"sid": 980355673329453,
											"parameters": {
												"variable": "potentialIntensity",
												"value": "clamp(1-(distance(dolls.X, dolls.Y, lightSource.X, lightSource.Y)*0.005), 0, .25)"
											}
										},
										{
											"id": "set-eventvar-value",
											"objectClass": "System",
											"sid": 618369850223288,
											"parameters": {
												"variable": "curIntensity",
												"value": "Functions.getEffectValue(\"RimLight\", 2, dolls.UID)"
											}
										}
									],
									"sid": 512019404869916
								},
								{
									"eventType": "block",
									"conditions": [
										{
											"id": "compare-two-values",
											"objectClass": "System",
											"sid": 653994748261739,
											"parameters": {
												"first-value": "potentialIntensity",
												"comparison": 4,
												"second-value": "curIntensity +.05"
											}
										}
									],
									"actions": [
										{
											"id": "set-eventvar-value",
											"objectClass": "System",
											"sid": 254018420476398,
											"parameters": {
												"variable": "intensity",
												"value": "lerp(curIntensity, potentialIntensity, 0.1 * 180 * dt)"
											}
										}
									],
									"sid": 175451084816536
								},
								{
									"eventType": "block",
									"conditions": [],
									"actions": [
										{
											"callFunction": "drawRrimLight",
											"sid": 982800200012483,
											"parameters": [
												"intensity"
											]
										}
									],
									"sid": 546423520202389
								}
							]
						},
						{
							"functionName": "drawRrimLight",
							"functionDescription": "",
							"functionCategory": "",
							"functionReturnType": "none",
							"functionCopyPicked": true,
							"functionIsAsync": false,
							"functionParameters": [
								{
									"name": "intensity",
									"type": "number",
									"initialValue": "-1",
									"comment": "",
									"sid": 972677546869532
								}
							],
							"eventType": "function-block",
							"conditions": [],
							"actions": [],
							"sid": 252479398774716,
							"children": [
								{
									"eventType": "block",
									"conditions": [],
									"actions": [
										{
											"type": "comment",
											"text": "color"
										},
										{
											"id": "set-effect-parameter",
											"objectClass": "dolls",
											"sid": 639338332312629,
											"parameters": {
												"effect": "\"RimLight\"",
												"parameter-index": "0",
												"value": "lightSource.ColorValue"
											}
										},
										{
											"type": "comment",
											"text": "size"
										},
										{
											"id": "set-effect-parameter",
											"objectClass": "dolls",
											"sid": 636364225399303,
											"parameters": {
												"effect": "\"RimLight\"",
												"parameter-index": "1",
												"value": "clamp(\n5-(distance(Self.X, Self.Y, lightSource.X, lightSource.Y)*0.005), 0, 2)"
											}
										},
										{
											"type": "comment",
											"text": "intensity"
										},
										{
											"id": "set-effect-parameter",
											"objectClass": "dolls",
											"sid": 499295060111331,
											"parameters": {
												"effect": "\"RimLight\"",
												"parameter-index": "2",
												"value": "intensity > -1 ? intensity :  clamp(1-(distance(Self.X, Self.Y, lightSource.X, lightSource.Y)*0.005), 0, .25)"
											}
										}
									],
									"sid": 311681923460139,
									"children": [
										{
											"eventType": "comment",
											"text": "angle"
										},
										{
											"eventType": "variable",
											"name": "angleDiffNum",
											"type": "number",
											"initialValue": "0",
											"comment": "",
											"isStatic": false,
											"isConstant": false,
											"sid": 880196493527183
										},
										{
											"eventType": "block",
											"conditions": [],
											"actions": [
												{
													"id": "set-eventvar-value",
													"objectClass": "System",
													"sid": 857157199427194,
													"parameters": {
														"variable": "angleDiffNum",
														"value": "floor( anglediff(0, dolls.Angle))"
													}
												}
											],
											"sid": 161487218256884
										},
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "is-mirrored",
													"objectClass": "dolls",
													"sid": 408915025767694,
													"isInverted": true
												}
											],
											"actions": [
												{
													"id": "set-effect-parameter",
													"objectClass": "dolls",
													"sid": 613843111160839,
													"parameters": {
														"effect": "\"RimLight\"",
														"parameter-index": "3",
														"value": "angle(Self.X, Self.Y, lightSource.X,lightSource.Y) - angleDiffNum"
													}
												}
											],
											"sid": 491221744393243
										},
										{
											"eventType": "block",
											"conditions": [
												{
													"id": "else",
													"objectClass": "System",
													"sid": 677366044175623
												}
											],
											"actions": [
												{
													"id": "set-effect-parameter",
													"objectClass": "dolls",
													"sid": 756254947498285,
													"parameters": {
														"effect": "\"RimLight\"",
														"parameter-index": "3",
														"value": "((angle(Self.X, Self.Y, lightSource.X,lightSource.Y) * -1) + 180) + angleDiffNum"
													}
												}
											],
											"sid": 592660806896543
										}
									]
								}
							]
						},
						{
							"functionName": "getEffectValue",
							"functionDescription": "",
							"functionCategory": "",
							"functionReturnType": "number",
							"functionCopyPicked": false,
							"functionIsAsync": false,
							"functionParameters": [
								{
									"name": "effectName",
									"type": "string",
									"initialValue": "",
									"comment": "",
									"sid": 135700939092375
								},
								{
									"name": "effectParamNum",
									"type": "number",
									"initialValue": "0",
									"comment": "",
									"sid": 844671505732611
								},
								{
									"name": "uid",
									"type": "number",
									"initialValue": "-1",
									"comment": "",
									"sid": 747790516173841
								}
							],
							"eventType": "function-block",
							"conditions": [],
							"actions": [],
							"sid": 628991994633022,
							"children": [
								{
									"eventType": "script",
									"script": "// THIS IS WHAT BROKE EVERYTHING: be careful using getFirstInstance in JS\n// const typeObject = runtime.objects[localVars.objectType];\n// const pickedInstance = typeObject.getFirstInstance();\n\nconst pickedInstance = runtime.getInstanceByUid(localVars.uid);\nif (pickedInstance) {\n\tconst myEffect = pickedInstance.effects.find((e)=> e.name === localVars.effectName )\n \tif (myEffect) {\n\t\tconst parameterValue = myEffect.getParameter(localVars.effectParamNum);\n\t\truntime.setReturnValue(parameterValue);\n\t}\n}"
								}
							]
						}
					],
					"sid": 634265090156054
				},
				{
					"eventType": "group",
					"disabled": false,
					"title": "Shadow",
					"description": "",
					"isActiveOnStart": true,
					"children": [],
					"sid": 942117125694033
				}
			],
			"sid": 564661993524078
		}
	],
	"sid": 397859464194922
}